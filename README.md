# Cascade: HPC 스케일 LLM 추론을 위한 4계층 KV 캐시 스토리지

> **SC'26 논문** | NERSC Perlmutter | A100 GPU | Slingshot-11

---

## 🎯 핵심 결과 (실제 벤치마크)

```
┌──────────────────────────────────────────────────────────────────────────────┐
│                     Cascade vs Baseline 성능 비교                             │
│                        (Job 48439256, 4 nodes)                                │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  📊 읽기 성능 (GB/s)                                                          │
│  ────────────────────────────────────────────────────────────────────────    │
│  Cascade (SHM mmap)  ████████████████████████████████████ 34.46 (aggregate)  │
│  Lustre (cold read)  ████ 4.35                                               │
│                                                                              │
│  ⚡ Speedup: 7.9× faster                                                      │
│                                                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  💾 Deduplication (100 sessions × 1.25MB prompt)                             │
│  ────────────────────────────────────────────────────────────────────────    │
│  LMCache   ████████████████████████████████████████ 125.0 MB (100 copies)   │
│  Cascade   █ 1.25 MB (1 copy)                                                │
│                                                                              │
│  📉 Storage Saved: 100×                                                       │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
```

---

## 🏆 Cascade의 3가지 핵심 차별점

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LMCache가 할 수 없는 것들                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. Content-Addressed Deduplication ──────────────── 100× 스토리지 절약    │
│     ┌──────────────────────────────────────────────────────────────┐       │
│     │  LMCache (세션별 ID):                                         │       │
│     │  ┌──────┐ ┌──────┐ ┌──────┐     ┌──────┐                     │       │
│     │  │Prompt│ │Prompt│ │Prompt│ ... │Prompt│  = 100개 복사본     │       │
│     │  │ #1   │ │ #2   │ │ #3   │     │ #100 │                     │       │
│     │  └──────┘ └──────┘ └──────┘     └──────┘                     │       │
│     │                                                               │       │
│     │  Cascade (SHA-256 해시):                                      │       │
│     │  ┌────────────────────────────────────────────────────────┐  │       │
│     │  │        Prompt (SHA256: a1b2c3d4...)                    │  │       │
│     │  │              1개만 저장! → 100× 절약                    │  │       │
│     │  └────────────────────────────────────────────────────────┘  │       │
│     │  Session #1 ──┐                                               │       │
│     │  Session #2 ──┼──→ 모두 같은 블록 참조                        │       │
│     │  Session #100 ┘                                               │       │
│     └──────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  2. 멀티노드 SHM Aggregation ────────────────────────── 4× 대역폭 (4노드)  │
│     ┌──────────────────────────────────────────────────────────────┐       │
│     │  Node 1: 8.79 GB/s ─┐                                         │       │
│     │  Node 2: 8.60 GB/s ─┼─→ Aggregate: 34.46 GB/s                │       │
│     │  Node 3: 8.58 GB/s ─┤   (MPI 기반 글로벌 주소 공간)            │       │
│     │  Node 4: 8.49 GB/s ─┘                                         │       │
│     └──────────────────────────────────────────────────────────────┘       │
│                                                                             │
│  3. SHM vs Lustre 성능 격차 ─────────────────────────── 7.9× faster        │
│     ┌──────────────────────────────────────────────────────────────┐       │
│     │  Storage Tier          │ Read (GB/s) │ Latency              │       │
│     │  ─────────────────────────────────────────────────────────  │       │
│     │  /dev/shm (mmap)       │    8.61     │    ~1-10 μs          │       │
│     │  Lustre (cold)         │    1.09     │    ~1000+ μs         │       │
│     │  ─────────────────────────────────────────────────────────  │       │
│     │  Speedup: 7.9×                                               │       │
│     └──────────────────────────────────────────────────────────────┘       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📊 상세 벤치마크 결과

### Job 48439256: SHM vs Lustre (4 nodes, 1GB/node)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Per-Node Performance (GB/s)                             │
├─────────────┬──────────────┬───────────────┬──────────────┬─────────────────┤
│   System    │    Write     │   Hot Read    │  Cold Read   │    Speedup      │
├─────────────┼──────────────┼───────────────┼──────────────┼─────────────────┤
│ SHM (mmap)  │    3.08      │     7.50      │    8.61*     │      ---        │
│ Lustre      │    0.62      │     7.96      │    1.09      │      ---        │
├─────────────┼──────────────┼───────────────┼──────────────┼─────────────────┤
│ SHM/Lustre  │    5.0×      │     0.94×     │    7.9×      │   7.9× (cold)   │
└─────────────┴──────────────┴───────────────┴──────────────┴─────────────────┘
* SHM은 항상 hot (메모리 상주)

┌─────────────────────────────────────────────────────────────────────────────┐
│                    Cluster Aggregate (4 Nodes, GB/s)                         │
├─────────────┬──────────────┬──────────────────────────────────────────────────┤
│   System    │   Read       │   Bar Graph                                      │
├─────────────┼──────────────┼──────────────────────────────────────────────────┤
│ SHM mmap    │   34.46      │ ████████████████████████████████████████████████ │
│ Lustre cold │    4.35      │ ██████                                           │
└─────────────┴──────────────┴──────────────────────────────────────────────────┘
```

### Deduplication Efficiency

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                  100개 세션이 같은 System Prompt 공유                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Prompt Size: 1.25 MB                                                      │
│   Sessions: 100                                                             │
│                                                                             │
│   LMCache (세션별 저장):                                                     │
│   ┌────────────────────────────────────────────────────────────────────┐   │
│   │  ████████████████████████████████████████  125.0 MB (100 copies)  │   │
│   └────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│   Cascade (SHA-256 해시):                                                    │
│   ┌─┐                                                                       │
│   │█│ 1.25 MB (1 copy)                                                     │
│   └─┘                                                                       │
│                                                                             │
│   📊 결과: 125.0 MB → 1.25 MB = 100× 절약!                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🔧 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Cascade 4-Tier Architecture                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   Tier 1: GPU HBM     ─── 1555 GB/s ─── 40GB × 4 = 160GB/노드               │
│      │                     (NVIDIA A100)                                    │
│      ↓ evict (async)                                                        │
│   Tier 2: 로컬 SHM    ─── 8.6 GB/s ─── /dev/shm 256GB/노드                  │
│      │                     (mmap direct access)                             │
│      ↓ MPI RMA                                                              │
│   Tier 3: 원격 SHM    ─── 22.8 GB/s* ─── Slingshot-11                       │
│      │                     (GPU-aware MPI)                                  │
│      ↓ async prefetch                                                       │
│   Tier 4: Lustre PFS  ─── 1.1 GB/s (cold) ─── $SCRATCH                      │
│                            (7.8 TB/s aggregate)                             │
│                                                                             │
│   * Slingshot-11: 200 Gb/s × 4 NIC = 22.8 GB/s measured per link            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 🚀 빠른 시작

### 벤치마크 실행

```bash
cd /pscratch/sd/s/sgkim/Skim-cascade

# SHM vs Lustre 핵심 벤치마크
sbatch benchmark/scripts/shm_vs_lustre_bench.sh

# 스케일링 벤치마크
sbatch benchmark/scripts/scaling_bench.sh

# 결과 확인
cat benchmark/results/shm_vs_lustre_*_aggregate.json
```

---

## 📦 디렉토리 구조

```
/pscratch/sd/s/sgkim/Skim-cascade/
├── cascade_Code/           # Cascade 구현
│   ├── cpp/               # C++ 코어 (mmap, MPI, 분산)
│   └── src/cascade/       # Python 래퍼
├── third_party/            # 비교 시스템들 (실제 설치)
│   ├── LMCache/           # torch 필요
│   ├── pdc/               # C/MPI
│   ├── redis/             # C
│   └── vllm/              # 참조용
├── benchmark/              # 벤치마크
│   ├── scripts/           # SLURM 스크립트
│   ├── results/           # JSON 결과
│   └── logs/              # 실행 로그
└── paper/                  # SC'26 논문
```

---

## 🔬 실험 환경 (Perlmutter)

| 구성요소 | 사양 |
|---------|------|
| **GPU** | NVIDIA A100-40GB × 4 = 160GB HBM/노드 |
| **CPU** | AMD EPYC 7763 (64 cores) |
| **DRAM** | 256GB DDR4/노드 |
| **SHM** | /dev/shm: ~428GB 사용 가능 |
| **인터커넥트** | Slingshot-11 (200 Gb/s × 4 NIC) |
| **스토리지** | Lustre $SCRATCH (44PB, 7.8 TB/s aggregate) |

---

## 📈 벤치마크 Job IDs

| Job ID | 테스트 | 결과 |
|--------|--------|------|
| 48439256 | SHM vs Lustre (4 nodes) | ✅ SHM 7.9× faster |
| 48439277 | Scaling (block size, volume) | 실행 중 |

---

## 🚨 연구 윤리

모든 벤치마크는 실제 구현을 사용해야 합니다.

```
❌ 절대 하면 안됨:
   - 단순 Python 파일 I/O를 "LMCache", "PDC"로 레이블링
   - 가짜 성능 수치 제시

✅ 올바른 방법:
   - third_party/의 실제 코드 사용
   - Job ID로 재현 가능성 보장
   - Cold read: posix_fadvise(DONTNEED)로 page cache 비우기
```

---

**Last Updated**: 2026-02-02  
**Author**: Sunggon Kim (sgkim@lbl.gov)
